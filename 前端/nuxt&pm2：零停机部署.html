<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nuxt&amp;pm2：零停机部署 | 学无止境</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="一个小弱鸡的博客">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/assets/css/0.styles.9f4a1d44.css" as="style"><link rel="preload" href="/assets/js/app.92cfd5ca.js" as="script"><link rel="preload" href="/assets/js/3.9c2ccc25.js" as="script"><link rel="preload" href="/assets/js/1.6b73b49f.js" as="script"><link rel="preload" href="/assets/js/19.523bd5e8.js" as="script"><link rel="prefetch" href="/assets/js/10.66767ece.js"><link rel="prefetch" href="/assets/js/11.4bdab4b5.js"><link rel="prefetch" href="/assets/js/12.6179307b.js"><link rel="prefetch" href="/assets/js/13.fcedbd9c.js"><link rel="prefetch" href="/assets/js/14.f51266f5.js"><link rel="prefetch" href="/assets/js/15.07c34514.js"><link rel="prefetch" href="/assets/js/16.c1df4280.js"><link rel="prefetch" href="/assets/js/17.62336bf6.js"><link rel="prefetch" href="/assets/js/18.a3e45778.js"><link rel="prefetch" href="/assets/js/20.0e567f99.js"><link rel="prefetch" href="/assets/js/21.a65f7df8.js"><link rel="prefetch" href="/assets/js/22.dc26e241.js"><link rel="prefetch" href="/assets/js/23.d2648500.js"><link rel="prefetch" href="/assets/js/24.aee40a80.js"><link rel="prefetch" href="/assets/js/25.3717fb7d.js"><link rel="prefetch" href="/assets/js/26.3e9da743.js"><link rel="prefetch" href="/assets/js/27.d3ed5636.js"><link rel="prefetch" href="/assets/js/28.d9cc3bed.js"><link rel="prefetch" href="/assets/js/29.025468dd.js"><link rel="prefetch" href="/assets/js/30.8d5784ee.js"><link rel="prefetch" href="/assets/js/31.5a1242d3.js"><link rel="prefetch" href="/assets/js/32.3ed2d5fb.js"><link rel="prefetch" href="/assets/js/33.68d8d6e6.js"><link rel="prefetch" href="/assets/js/34.4de99795.js"><link rel="prefetch" href="/assets/js/35.458ff59e.js"><link rel="prefetch" href="/assets/js/36.bba29a48.js"><link rel="prefetch" href="/assets/js/37.393b6257.js"><link rel="prefetch" href="/assets/js/4.69bf606d.js"><link rel="prefetch" href="/assets/js/5.8080b762.js"><link rel="prefetch" href="/assets/js/6.98aa6c76.js"><link rel="prefetch" href="/assets/js/7.714cbab1.js"><link rel="prefetch" href="/assets/js/8.cfb32dd7.js"><link rel="prefetch" href="/assets/js/9.d6a52af7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9f4a1d44.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-cea4b09a><div data-v-cea4b09a><div class="password-shadow password-wrapper-out" style="display:none;" data-v-51b4f498 data-v-cea4b09a data-v-cea4b09a><h3 class="title" data-v-51b4f498>学无止境</h3> <p class="description" data-v-51b4f498>一个小弱鸡的博客</p> <label id="box" class="inputBox" data-v-51b4f498><input type="password" value="" data-v-51b4f498> <span data-v-51b4f498>Konck! Knock!</span> <button data-v-51b4f498>OK</button></label> <div class="footer" data-v-51b4f498><span data-v-51b4f498><i class="iconfont reco-theme" data-v-51b4f498></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-51b4f498>vuePress-theme-reco</a></span> <span data-v-51b4f498><i class="iconfont reco-copyright" data-v-51b4f498></i> <a data-v-51b4f498><span data-v-51b4f498>hpstream</span>
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-cea4b09a><header class="navbar" data-v-cea4b09a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">学无止境</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-date"></i>
  主页
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间排序
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-menu"></i>
      相关
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/hpstream" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.jianshu.com/u/0e190d5b2e72" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-jianshu"></i>
  简书
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/~hpstream" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-npm"></i>
  NPM
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/商学院_个人篇/" class="nav-link"><i class="undefined"></i>
  商学院_个人篇
</a></li><li class="dropdown-item"><!----> <a href="/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/categories/人生思考/" class="nav-link"><i class="undefined"></i>
  人生思考
</a></li><li class="dropdown-item"><!----> <a href="/categories/技术/" class="nav-link"><i class="undefined"></i>
  技术
</a></li><li class="dropdown-item"><!----> <a href="/categories/webpack/" class="nav-link"><i class="undefined"></i>
  webpack
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-cea4b09a></div> <aside class="sidebar" data-v-cea4b09a><div class="personal-info-wrapper" data-v-04fc7b65 data-v-cea4b09a><img src="/face.jpeg" alt="author-avatar" class="personal-img" data-v-04fc7b65> <h3 class="name" data-v-04fc7b65>
    hpstream
  </h3> <div class="num" data-v-04fc7b65><div data-v-04fc7b65><h3 data-v-04fc7b65>25</h3> <h6 data-v-04fc7b65>文章</h6></div> <div data-v-04fc7b65><h3 data-v-04fc7b65>15</h3> <h6 data-v-04fc7b65>标签</h6></div></div> <ul class="social-links" data-v-04fc7b65></ul> <hr data-v-04fc7b65></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-date"></i>
  主页
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间排序
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-menu"></i>
      相关
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/hpstream" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.jianshu.com/u/0e190d5b2e72" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-jianshu"></i>
  简书
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.npmjs.com/~hpstream" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-npm"></i>
  NPM
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/商学院_个人篇/" class="nav-link"><i class="undefined"></i>
  商学院_个人篇
</a></li><li class="dropdown-item"><!----> <a href="/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/categories/人生思考/" class="nav-link"><i class="undefined"></i>
  人生思考
</a></li><li class="dropdown-item"><!----> <a href="/categories/技术/" class="nav-link"><i class="undefined"></i>
  技术
</a></li><li class="dropdown-item"><!----> <a href="/categories/webpack/" class="nav-link"><i class="undefined"></i>
  webpack
</a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-51b4f498 data-v-cea4b09a><h3 class="title" data-v-51b4f498>nuxt&amp;pm2：零停机部署</h3> <!----> <label id="box" class="inputBox" data-v-51b4f498><input type="password" value="" data-v-51b4f498> <span data-v-51b4f498>Konck! Knock!</span> <button data-v-51b4f498>OK</button></label> <div class="footer" data-v-51b4f498><span data-v-51b4f498><i class="iconfont reco-theme" data-v-51b4f498></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-51b4f498>vuePress-theme-reco</a></span> <span data-v-51b4f498><i class="iconfont reco-copyright" data-v-51b4f498></i> <a data-v-51b4f498><span data-v-51b4f498>hpstream</span>
          
        <!---->
        2023
      </a></span></div></div> <div data-v-cea4b09a><div data-v-cea4b09a><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">nuxt&amp;pm2：零停机部署</h1> <div data-v-7bebb058><i class="iconfont reco-account" data-v-7bebb058><span data-v-7bebb058>hpstream</span></i> <i class="iconfont reco-date" data-v-7bebb058><span data-v-7bebb058>2019-10-18</span></i> <i class="iconfont reco-eye" data-v-7bebb058><span id="/%E5%89%8D%E7%AB%AF/nuxt&amp;pm2%EF%BC%9A%E9%9B%B6%E5%81%9C%E6%9C%BA%E9%83%A8%E7%BD%B2.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-7bebb058><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-7bebb058><span class="tag-item" data-v-7bebb058>nuxt</span><span class="tag-item" data-v-7bebb058>pm2</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="nuxt-pm2-零停机部署"><a href="#nuxt-pm2-零停机部署" class="header-anchor">#</a> nuxt&amp;pm2：零停机部署</h1> <h2 id="中文版"><a href="#中文版" class="header-anchor">#</a> 中文版：</h2> <p>nuxt是一个非常棒的vue.js框架，它使得建立ssr站点变得非常简单。nuxt在引擎盖下使用node.js服务器来呈现服务器端的页面。
ssr有很多优点，在许多其他文章中都有深入的介绍，但是对于本文，我们将重点关注nuxt服务器的部署。
对于node.js应用程序来说，pm2是一个很好的进程管理器，它有许多很好的特性，包括通过“cluster mode”实现负载平衡。cluster mode创建node.js进程的多个实例，以便在不修改任何代码的情况下跨多个cpu扩展应用程序。
除了利用多个cpu的性能优势外，集群模式还允许通过一次重新加载一个实例来实现零停机部署。因此，如果您有4个实例在运行，您可以一次重新加载一个实例，而当一个实例正在重新加载时，其他3个实例将使服务器保持活动状态。因此，服务器可以在不离线的情况下更新一秒。
对于大多数节点应用程序来说，设置和使用pm2集群模式非常容易，但是我们在尝试将集群模式与nuxt服务器一起使用时遇到了一些问题。
首先，我们可以尝试使用以下命令启动nuxt服务器的单个实例：</p> <blockquote><p>pm2 start npm --name MyAppName -- start</p></blockquote> <p><img src="https://cdn.nlark.com/yuque/0/2019/png/119800/1571366065910-cde60771-9fd6-42e7-bead-6110416bc662.png#align=left&amp;display=inline&amp;height=203&amp;name=image.png&amp;originHeight=203&amp;originWidth=907&amp;search=&amp;size=42471&amp;status=done&amp;width=907" alt="image.png"></p> <p>但是，当尝试启动多个实例时，我们很快就会遇到问题。
例如，如果我们运行该命令两次，就会遇到错误。
<img src="https://cdn.nlark.com/yuque/0/2019/png/119800/1571366113466-8add96e9-f0cc-413d-bd9f-9d269a3dcd9f.png#align=left&amp;display=inline&amp;height=1087&amp;name=image.png&amp;originHeight=1087&amp;originWidth=2188&amp;search=&amp;size=297488&amp;status=done&amp;width=2188" alt="image.png"></p> <p>现在，虽然默认情况下是在“fork”模式下运行，但即使指定集群模式，也会遇到错误。
如果我们只使用一个实例并尝试重新加载服务器呢？好吧，由于nuxt在幕后的工作方式，如果我们试图在服务器运行时重建它，那么在删除生成文件并为新的生成重新设置灰烬之后，我们将遇到404个错误。如果静态文件夹中的文件发生更改，我们也会遇到问题。
因此，如果我们不能重建和重新加载服务器，并且不能运行多个实例，那么我们如何实现零停机部署？</p> <h2 id="正确配置pm2集群模式"><a href="#正确配置pm2集群模式" class="header-anchor">#</a> 正确配置PM2集群模式</h2> <p>我们之前遇到问题是因为我们试图以“错误的方式”生成服务器的多个实例。在我们的实例中，我们让pm2执行'npm run start'，实际上是启动npm脚本执行的多个实例，而不是直接正确地启动服务器。在启动实例后，我们可以在控制台中看到这一点：</p> <blockquote><p>[PM2] Starting /usr/bin/npm in fork_mode (1 instance)</p></blockquote> <p>如您所见，我们启动npm，然后通过命令行参数告诉npm启动服务器。相反，我们应该使用pm2直接调用服务器的启动脚本。使用以下命令启动nuxt服务器：</p> <blockquote><p>Nuxt start</p></blockquote> <p>但是，如果我们试图告诉PM2启动NUXT，它就不会起作用。相反，我们需要直接指向脚本nuxt调用，它位于</p> <blockquote><p>./node_modules/nuxt/bin/nuxt-start</p></blockquote> <p>现在用node_modules文件夹中的脚本启动pm2会很乏味，必须有更好的方法。谢天谢地，有！pm2允许我们创建一个生态系统文件，它基本上是pm2命令的配置文件。我们可以指定诸如要运行的脚本、工作目录、要生成多少实例以及别名等属性。<a href="https://pm2.io/doc/en/runtime/reference/ecosystem-file/" target="_blank" rel="noopener noreferrer">您可以在这里看到所有可用的属性。<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>因此，现在我们知道需要运行什么脚本，并且知道需要使用什么设置来执行该脚本，我们可以通过运行以下命令来创建生态系统文件：</p> <blockquote><p>pm2 init</p></blockquote> <p>然后，我们将按如下方式配置此文件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">apps</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token literal-property property">name</span>      <span class="token operator">:</span> <span class="token string">'MyAppName'</span><span class="token punctuation">,</span> <span class="token comment">// App name that shows in `pm2 ls`</span>
        <span class="token literal-property property">exec_mode</span> <span class="token operator">:</span> <span class="token string">'cluster'</span><span class="token punctuation">,</span> <span class="token comment">// enables clustering</span>
        <span class="token literal-property property">instances</span> <span class="token operator">:</span> <span class="token string">'max'</span><span class="token punctuation">,</span> <span class="token comment">// or an integer</span>
        <span class="token literal-property property">cwd</span>       <span class="token operator">:</span> <span class="token string">'./current'</span><span class="token punctuation">,</span> <span class="token comment">// only if using a subdirectory</span>
        <span class="token literal-property property">script</span>    <span class="token operator">:</span> <span class="token string">'./node_modules/nuxt/bin/nuxt-start'</span><span class="token punctuation">,</span> <span class="token comment">// The magic key</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>您可能注意到我正在指定一个当前工作目录（CWD）。我这么做是因为这允许我们在幕后交换服务器代码，而不会遇到nuxt造成的限制。
我们通过创建如下文件结构来完成此操作：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">/</span>MyAppName
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">/</span>releases
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">/</span>v1<span class="token punctuation">.</span><span class="token number">0.0</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">/</span>v1<span class="token punctuation">.</span><span class="token number">1.0</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">/</span>v1<span class="token punctuation">.</span><span class="token number">2.0</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">/</span><span class="token operator">...</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">/</span>current <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token operator">/</span>releases<span class="token operator">/</span>v1<span class="token punctuation">.</span><span class="token number">2.0</span> <span class="token punctuation">(</span>symlink<span class="token punctuation">)</span>
<span class="token operator">|</span><span class="token operator">--</span>ecosystem<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js
</code></pre></div><p>要启动服务器，只需在/myappname目录中运行以下命令：</p> <blockquote><p>pm2 start</p></blockquote> <p>现在要部署，我们只需将最新版本的repo克隆到“/releases”下的新文件夹，构建新版本（或者，您可以使用ci/cd服务提前构建该版本，并直接将这些构建文件上载到服务器）。然后我们将符号链接从/releases/v1.2.0更新到/releases/v1.3.0并运行：</p> <blockquote><p>pm2 reload MyAppName</p></blockquote> <p><img src="https://cdn.nlark.com/yuque/0/2019/png/119800/1571366620550-67e5799e-9605-4ef1-9d92-81d538af6625.png#align=left&amp;display=inline&amp;height=1310&amp;name=image.png&amp;originHeight=1310&amp;originWidth=1412&amp;search=&amp;size=314295&amp;status=done&amp;width=1412" alt="image.png"></p> <p>成功！现在，您可以生成多个nuxt服务器实例以获得更好的性能（在多线程系统上），并利用零停机部署在更新期间保持网站</p> <p>希望这能帮助你充分利用你的项目！</p> <h2 id="英文版"><a href="#英文版" class="header-anchor">#</a> 英文版：</h2> <h2 id="nuxt-pm2-zero-downtime-deployment"><a href="#nuxt-pm2-zero-downtime-deployment" class="header-anchor">#</a> Nuxt &amp; PM2: Zero Downtime Deployment</h2> <p>Nuxt is an awesome framework for Vue.js that makes setting up an SSR site super simple. Nuxt uses a Node.js server under the hood in order to render pages server side.
<a href="https://medium.com/walmartlabs/the-benefits-of-server-side-rendering-over-client-side-rendering-5d07ff2cefe8" target="_blank" rel="noopener noreferrer">There are many advantages to SSR<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, which are covered in depth in many other posts, but for this post we are going to be focusing on the deployment of a Nuxt server.
PM2 is a great process manager for Node.js applications, with many great features including load balancing through “<a href="https://pm2.io/doc/en/runtime/guide/load-balancing/" target="_blank" rel="noopener noreferrer">cluster mode<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.” Cluster mode creates multiple instances of a Node.js process in order to allow applications to be scaled across multiple CPUs without any code modifications.
Besides the performance advantage of utilizing multiple CPUs, cluster mode also allows for a zero downtime deployment by reloading the server process one instance at a time. Thus if you have 4 instances running, you can reload the server one instance at a time, and while one instance is reloading, the other 3 instances will keep the server alive. Thus a server can be updated without being taken offline for even a second.
Setting up and using PM2 cluster mode is extremely easy for most node applications, however we run into some issues attempting to use cluster mode with a Nuxt server.
First we can try starting a single instance of our nuxt server with the following command:
$ pm2 start npm --name MyAppName -- start
<img src="https://cdn.nlark.com/yuque/0/2019/png/119800/1571366857344-febbb55f-1434-4ae5-b318-fab64df3d8e2.png#align=left&amp;display=inline&amp;height=203&amp;name=image.png&amp;originHeight=203&amp;originWidth=907&amp;search=&amp;size=42471&amp;status=done&amp;width=907" alt="image.png"></p> <p>But we quickly run into issues when trying to start multiple instances.
For example, if we run that command twice, we’ll run into errors.
<img src="https://cdn.nlark.com/yuque/0/2019/png/119800/1571366882225-a5c54460-1db3-4f0b-b27a-667270d972cd.png#align=left&amp;display=inline&amp;height=1087&amp;name=image.png&amp;originHeight=1087&amp;originWidth=2188&amp;search=&amp;size=297488&amp;status=done&amp;width=2188" alt="image.png"></p> <p>Now while that is by default running in “fork” mode, even if we specify cluster mode, we run into errors.
What if we only use 1 instance and attempt to reload the server? Well due to how Nuxt works under the hood, if we attempt to rebuild the server while it’s running, we’ll hit 404 errors after the build files are removed and rehashed for the new build. We also run into issues if files in our static folder are changed.
So if we can’t just rebuild and reload a server, and we can’t run multiple instances, then how do we achieve a zero downtime deployment?</p> <h2 id="properly-configure-pm2-cluster-mode"><a href="#properly-configure-pm2-cluster-mode" class="header-anchor">#</a> Properly Configure PM2 Cluster Mode</h2> <p>We were running into issues previously because we were attempting to spawn multiple instances of our server in the “wrong way”. In our instance we are having PM2 execute <code>npm run start</code> which essentially is starting multiple instances of npm script executions, and not properly launching our server directly. We can see this in our console after starting an instance:</p> <blockquote><p>[PM2] Starting /usr/bin/npm in fork_mode (1 instance)</p></blockquote> <p>As you can see, we’re starting npm and then telling npm to start our server through it’s command line arguments. Instead of this, we should be using PM2 to call the server’s start script directly. Starting a Nuxt server is done with the following command:</p> <blockquote><p>Nuxt start</p></blockquote> <p>However, if we try to tell PM2 to start Nuxt, it won’t work. Instead, we need to point directly to the script Nuxt calls, which is located in</p> <blockquote><p>./node_modules/nuxt/bin/nuxt-start</p></blockquote> <p>Now starting PM2 with a script from the node_modules folder is going to be tedious, there has to be a better way. Thankfully, there is! PM2 allows us to create an Ecosystem File, which is basically a configuration file for our PM2 commands. We can specify properties such as the script to run, the working directory, how many instances to spawn, and an alias name. You can see <a href="https://pm2.io/doc/en/runtime/reference/ecosystem-file/" target="_blank" rel="noopener noreferrer">all available properties here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.
So now that we know what script we need to run, and we know what settings we need to execute that script with, we can create the ecosystem file by running the following command:</p> <blockquote><p>pm2 init</p></blockquote> <p>We’ll then configure this file as such:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">apps</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token literal-property property">name</span>      <span class="token operator">:</span> <span class="token string">'MyAppName'</span><span class="token punctuation">,</span> <span class="token comment">// App name that shows in `pm2 ls`</span>
        <span class="token literal-property property">exec_mode</span> <span class="token operator">:</span> <span class="token string">'cluster'</span><span class="token punctuation">,</span> <span class="token comment">// enables clustering</span>
        <span class="token literal-property property">instances</span> <span class="token operator">:</span> <span class="token string">'max'</span><span class="token punctuation">,</span> <span class="token comment">// or an integer</span>
        <span class="token literal-property property">cwd</span>       <span class="token operator">:</span> <span class="token string">'./current'</span><span class="token punctuation">,</span> <span class="token comment">// only if using a subdirectory</span>
        <span class="token literal-property property">script</span>    <span class="token operator">:</span> <span class="token string">'./node_modules/nuxt/bin/nuxt-start'</span><span class="token punctuation">,</span> <span class="token comment">// The magic key</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>You may notice I’m specifying a current working directory (cwd). I’m doing this because this is what allows us to swap our server code behind the scenes without running into the limitations caused by Nuxt.
We do this by creating a file structure like this:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">/</span>MyAppName
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">/</span>releases
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">/</span>v1<span class="token punctuation">.</span><span class="token number">0.0</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">/</span>v1<span class="token punctuation">.</span><span class="token number">1.0</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">/</span>v1<span class="token punctuation">.</span><span class="token number">2.0</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">/</span><span class="token operator">...</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">/</span>current <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token operator">/</span>releases<span class="token operator">/</span>v1<span class="token punctuation">.</span><span class="token number">2.0</span> <span class="token punctuation">(</span>symlink<span class="token punctuation">)</span>
<span class="token operator">|</span><span class="token operator">--</span>ecosystem<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js
</code></pre></div><p>To start our server, we just need to run the following command from within the /MyAppName directory:</p> <blockquote><p>pm2 start</p></blockquote> <p>Now to deploy we just clone the latest version of our repo to a new folder under ‘/releases’, build our new version (or alternatively, you can use a CI/CD service to build that version ahead of time, and directly upload those build files to the server). Then we just update the symlink from /releases/v1.2.0 to /releases/v1.3.0 and run:</p> <blockquote><p>pm2 reload MyAppName</p></blockquote> <p><img src="https://cdn.nlark.com/yuque/0/2019/png/119800/1571367083713-5c870a29-d74c-4a14-8624-92ad1afc061d.png#align=left&amp;display=inline&amp;height=1310&amp;name=image.png&amp;originHeight=1310&amp;originWidth=1412&amp;search=&amp;size=314295&amp;status=done&amp;width=1412" alt="image.png"></p> <p>Success! You’re now able to spawn multiple instances of your Nuxt server for better performance (on multi threaded systems), AND take advantage of zero downtime deployments to keep your website online during updates.
Hopefully this helps you make the most out of your project!</p> <p>参考：</p> <p><a href="https://medium.com/@vipercodegames/nuxt-deploy-809eda0168fc" target="_blank" rel="noopener noreferrer">Zero Downtime Deployment<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新: </span> <span class="time">2019-10-18 11:03:51 ├F10: AM┤</span></div></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-72c6ec1e data-v-cea4b09a><li class="level-2" data-v-72c6ec1e><a href="/%E5%89%8D%E7%AB%AF/nuxt&amp;pm2%EF%BC%9A%E9%9B%B6%E5%81%9C%E6%9C%BA%E9%83%A8%E7%BD%B2.html#中文版" class="sidebar-link reco-side-中文版" data-v-72c6ec1e>中文版：</a></li><li class="level-2" data-v-72c6ec1e><a href="/%E5%89%8D%E7%AB%AF/nuxt&amp;pm2%EF%BC%9A%E9%9B%B6%E5%81%9C%E6%9C%BA%E9%83%A8%E7%BD%B2.html#正确配置pm2集群模式" class="sidebar-link reco-side-正确配置pm2集群模式" data-v-72c6ec1e>正确配置PM2集群模式</a></li><li class="level-2" data-v-72c6ec1e><a href="/%E5%89%8D%E7%AB%AF/nuxt&amp;pm2%EF%BC%9A%E9%9B%B6%E5%81%9C%E6%9C%BA%E9%83%A8%E7%BD%B2.html#英文版" class="sidebar-link reco-side-英文版" data-v-72c6ec1e>英文版：</a></li><li class="level-2" data-v-72c6ec1e><a href="/%E5%89%8D%E7%AB%AF/nuxt&amp;pm2%EF%BC%9A%E9%9B%B6%E5%81%9C%E6%9C%BA%E9%83%A8%E7%BD%B2.html#nuxt-pm2-zero-downtime-deployment" class="sidebar-link reco-side-nuxt-pm2-zero-downtime-deployment" data-v-72c6ec1e>Nuxt &amp; PM2: Zero Downtime Deployment</a></li><li class="level-2" data-v-72c6ec1e><a href="/%E5%89%8D%E7%AB%AF/nuxt&amp;pm2%EF%BC%9A%E9%9B%B6%E5%81%9C%E6%9C%BA%E9%83%A8%E7%BD%B2.html#properly-configure-pm2-cluster-mode" class="sidebar-link reco-side-properly-configure-pm2-cluster-mode" data-v-72c6ec1e>Properly Configure PM2 Cluster Mode</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-2a01419c data-v-2a01419c><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-2a01419c><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-2a01419c></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-2a01419c></path></svg></div></div></div>
    <script src="/assets/js/app.92cfd5ca.js" defer></script><script src="/assets/js/3.9c2ccc25.js" defer></script><script src="/assets/js/1.6b73b49f.js" defer></script><script src="/assets/js/19.523bd5e8.js" defer></script>
  </body>
</html>
